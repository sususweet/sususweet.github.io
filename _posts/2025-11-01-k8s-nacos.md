---
layout: post
title: kubernetes部署nacos集群
categories: [Cloud]
description: kubernetes部署nacos集群
keywords: nacos, K8S
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---

Nacos是一个开源的动态服务发现、配置管理和服务管理平台，可以在Kubernetes集群中方便地实现服务注册和发现、配置中心以及路由管理等功能。本文将介绍如何在Kubernetes集群中部署Nacos集群。

## 步骤一：创建Nacos服务

首先，需要创建一个Nacos服务。可以使用以下命令在Kubernetes集群中创建一个Nacos服务：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nacos
spec:
  selector:
    app: nacos
  type: ClusterIP
  ports:
  - name: http
    port: 8848
    targetPort: 8848
```

上述配置文件将创建一个名为“nacos”的服务，并使用ClusterIP类型。服务将公开Kubernetes集群中所有具有标签“app: nacos”的Pod。服务还将使用端口“8848”将请求路由到Pod中的端口“8848”。

也可以采用NodePort类型建立服务，这样就能够通过外部网络访问控制台：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nacos
spec:
  selector:
    app: nacos
  type: NodePort
  ports:
  - name: http
    port: 8848
    targetPort: 8848
    protocol: TCP
    nodePort: 30848
```
上述配置文件将创建一个名为“nacos”的服务，并使用NodePort类型。服务将公开Kubernetes集群中所有具有标签“app: nacos”的Pod。服务还将使用端口“8848”将请求路由到Pod中的端口“8848”，还可以通过30848端口从外部访问后台。
## 步骤二：创建Nacos部署
接下来，我们需要创建一个Nacos部署。可以使用以下命令在Kubernetes集群中创建一个Nacos部署：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nacos
  labels:
    app: nacos
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nacos
  template:
    metadata:
      labels:
        app: nacos
    spec:
      containers:
      - name: nacos
        image: nacos/nacos-server:latest
        imagePullPolicy: Always
        ports:
        - name: http
          containerPort: 8848
        - name: cluster
          containerPort: 8849
        env:
        - name: MODE
          value: "cluster"
        - name: SPRING_DATASOURCE_PLATFORM
          value: "mysql"
        - name: MYSQL_SERVICE_HOST
          value: "<MYSQL_HOST>"
        - name: MYSQL_SERVICE_PORT
          value: "3306"
        - name: MYSQL_SERVICE_DB_NAME
          value: "nacos_config"
        - name: MYSQL_SERVICE_USER
          valueFrom:
            secretKeyRef:
              name: nacos-mysql-secret
              key: username
        - name: MYSQL_SERVICE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nacos-mysql-secret
              key: password
```


上述配置文件将创建一个名为“nacos”的部署，并创建2个Pod。该部署使用最新版本的Nacos服务器Docker映像，并将其暴露在端口“8848”和“8849”上。部署使用MySQL作为数据库，并且需要提供MySQL主机的IP地址和端口号。此外，配置还需要提供MySQL的用户名和密码，这些敏感信息可以通过Kubernetes的Secret对象传递。

## 步骤三：创建Nacos数据库
在上述配置中，我们使用MySQL作为Nacos的数据库。因此，我们需要在MySQL中创建一个数据库和相应的用户。可以使用以下命令在MySQL中创建一个数据库和用户：

```bash
mysql> CREATE DATABASE nacos_config;
mysql> CREATE USER '<USERNAME>'@'<HOSTNAME>' IDENTIFIED BY '<PASSWORD>';
mysql> GRANT ALL PRIVILEGES ON nacos_config.* TO '<USERNAME>'@'<HOSTNAME>';
mysql> FLUSH PRIVILEGES;
```

在上述命令中，替换<USERNAME>、<HOSTNAME>和<PASSWORD>为你自己的值。这些值将在后续的步骤中使用。

## 步骤四：创建Nacos MySQL凭据
接下来，我们需要创建一个Kubernetes的Secret对象，其中包含MySQL的用户名和密码，这些信息将在Nacos部署中使用。可以使用以下命令创建一个Secret对象：

```bash
kubectl create secret generic nacos-mysql-secret --from-literal=username=<USERNAME> --from-literal=password=<PASSWORD>
```

在上述命令中，替换<USERNAME>和<PASSWORD>为你在步骤三中创建的MySQL用户名和密码。
在：https://raw.githubusercontent.com/alibaba/nacos/develop/distribution/conf/mysql-schema.sql 下载数据库初始化使用的sql文件，并导入数据库。
## 步骤五：部署Nacos集群
现在我们已经准备好了所有必要的资源来部署Nacos集群。可以使用以下命令在Kubernetes集群中部署Nacos：

```bash
kubectl apply -f nacos-service.yaml
kubectl apply -f nacos-deployment.yaml
```

等待一段时间，直到所有的Pod都变成Running状态，表示Nacos集群已经成功部署。
如果Pod不断重启，可以进入对应的Pod查看日志，一般是数据库连接失败造成无法正常启动。
## 步骤六：测试Nacos集群
可以使用以下命令测试Nacos集群是否正常运行：

```bash
kubectl port-forward svc/nacos 8848:8848
```

该命令将在本地主机的端口“8848”上启动端口转发，将请求路由到Kubernetes集群中的Nacos服务。在本地计算机上打开浏览器，访问“http://localhost:8848/nacos”以打开Nacos Web界面。

在Nacos Web界面中，你应该能够看到Nacos集群的各个节点，以及已经注册的服务、配置和路由。这表明Nacos集群已经成功部署并正在运行。